---
import Default from '@astrojs/starlight/components/SocialIcons.astro'
import type { Props } from '@astrojs/starlight/props'

// TODO(HiDeoo) only certain page?
// TODO(HiDeoo) mobile/responsive
// TODO(HiDeoo) click = link to doc for specific override
// TODO(HiDeoo) click = copy name?
// TODO(HiDeoo) click = modal containing everything with an example and everything?
---

<starlight-override-map></starlight-override-map>
<Default {...Astro.props}><slot /></Default>

<style is:global>
  :root {
    --starlight-override-map-accent-color: hsl(347 77% 50%);
  }

  :root[data-theme='light'] {
    --starlight-override-map-accent-color: hsl(345 83% 41%);
  }
</style>

<script>
  const overrides: Override[] = [
    // FIXME(HiDeoo) Head
    // FIXME(HiDeoo) Accessibility
    // Layout
    { name: 'PageFrame', selector: '.page', offset: -2 },
    // TODO(HiDeoo) MobileMenuToggle
    { name: 'TwoColumnContent', selector: '.lg\\:sl-flex' },
    // Header
    { name: 'Header', selector: 'div.header', offset: { block: 8, inline: 20 } },
    { name: 'SiteTitle', selector: '.site-title', offset: { inline: 8 } },
    { name: 'Search', selector: 'site-search button', offset: 6 },
    // TODO(HiDeoo) search modal?
    // TODO(HiDeoo) SocialIcons
    { name: 'ThemeSelect', selector: 'starlight-theme-select label', offset: { inline: 8 } },
    // TODO(HiDeoo) LanguageSelect
    // Global Sidebar
    { name: 'Sidebar', selector: '.sidebar-content', offset: -2 },
    // TODO(HiDeoo) MobileMenuFooter
    // Page Sidebar
    { name: 'PageSidebar', selector: '.right-sidebar', offset: { block: -2 } },
    { name: 'TableOfContents', selector: 'starlight-toc', offset: 8 },
    // TODO(HiDeoo) MobileTableOfContents
    // Content
    // TODO(HiDeoo) Banner
    { name: 'ContentPanel', selector: '.content-panel' },
    { name: 'PageTitle', selector: 'h1#_top', offset: { inline: 8 } },
    // TODO(HiDeoo) DraftContentNotice
    // TODO(HiDeoo) FallbackContentNotice
    // TODO(HiDeoo) Hero
    { name: 'MarkdownContent', selector: '.sl-markdown-content', offset: 8 },
    // Footer
    { name: 'Footer', selector: 'footer', offset: 8 },
    // TODO(HiDeoo) LastUpdated
    // TODO(HiDeoo) EditLink
    // TODO(HiDeoo) Pagination
  ]

  customElements.define(
    'starlight-override-map',
    class StarlightOverrideMap extends HTMLElement {
      static #didRegisterListeners = false
      #highlight: HTMLDivElement | undefined
      #tooltip: HTMLDivElement | undefined

      constructor() {
        super()

        if (!StarlightOverrideMap.#didRegisterListeners) {
          this.#createOverlay()
          this.#registerListeners()
        }
      }

      #registerListeners() {
        StarlightOverrideMap.#didRegisterListeners = true

        const inEvents = ['focus', 'mouseover'] as const
        const outEvents = ['blur', 'mouseout'] as const

        for (const override of overrides) {
          const elements = document.querySelectorAll(override.selector)
          // TODO(HiDeoo) validate only 1 element (not always the case)

          for (const element of elements) {
            for (const event of inEvents) {
              element.addEventListener(event, () => this.#showOverlay(override, element), { capture: true })
            }

            for (const event of outEvents) {
              element.addEventListener(event, () => this.#hideOverlay())
            }
          }
        }
      }

      #createOverlay() {
        this.#highlight = document.createElement('div')
        this.#highlight.style.border = `2px dashed var(--starlight-override-map-accent-color)`
        this.#highlight.style.display = 'none'
        this.#highlight.style.pointerEvents = 'none'
        this.#highlight.style.position = 'absolute'
        this.#highlight.style.zIndex = '100'

        this.#tooltip = document.createElement('div')
        this.#tooltip.style.backgroundColor = 'var(--starlight-override-map-accent-color)'
        this.#tooltip.style.color = 'white'
        this.#tooltip.style.display = 'none'
        this.#tooltip.style.padding = '0.375rem 0.625rem'
        this.#tooltip.style.pointerEvents = 'none'
        this.#tooltip.style.position = 'absolute'
        this.#tooltip.style.zIndex = '101'

        document.body.append(this.#highlight)
        document.body.append(this.#tooltip)
      }

      #showOverlay(override: Override, element: Element) {
        if (!this.#highlight || !this.#tooltip) return

        const rect = element.getBoundingClientRect()
        const blockOffset = typeof override.offset === 'number' ? override.offset : (override.offset?.block ?? 0)
        const inlineOffset = typeof override.offset === 'number' ? override.offset : (override.offset?.inline ?? 0)
        // This is probably a bit fragile so probably a good refactor candidate.
        const isTooltipInside = rect.height < 100

        this.#highlight.style.top = `${rect.top + window.scrollY - blockOffset}px`
        this.#highlight.style.left = `${rect.left + window.scrollX - inlineOffset}px`
        this.#highlight.style.width = `${rect.width + inlineOffset * 2}px`
        this.#highlight.style.height = `${rect.height + blockOffset * 2}px`
        this.#highlight.style.display = 'block'

        this.#tooltip.style.top = isTooltipInside
          ? `${rect.top + window.scrollY + rect.height + blockOffset - 2}px`
          : `${rect.top + window.scrollY - blockOffset}px`
        this.#tooltip.style.left = `${rect.left + window.scrollX - inlineOffset}px`
        this.#tooltip.style.display = 'block'
        this.#tooltip.textContent = override.name
      }

      #hideOverlay() {
        if (!this.#tooltip || !this.#highlight) return

        this.#highlight.style.display = 'none'
        this.#tooltip.style.display = 'none'
      }
    },
  )

  interface Override {
    name: string
    // In pixels
    offset?: number | { block?: number; inline?: number }
    selector: string
  }
</script>
