---
import Default from '@astrojs/starlight/components/SocialIcons.astro'
import type { Props } from '@astrojs/starlight/props'

// TODO(HiDeoo) only certain page?
---

<starlight-override-map>plop</starlight-override-map>
<Default {...Astro.props}><slot /></Default>

<script>
  customElements.define(
    'starlight-override-map',
    class StarlightOverrideMap extends HTMLElement {
      static #didRegisterListeners = false
      static #overrides: Override[] = [
        // Header
        { name: 'Header', selector: 'div.header' },
        { name: 'SiteTitle', selector: '.site-title' },
        // TODO(HiDeoo) search modal?
        { name: 'Search', selector: 'site-search button' },
        // TODO(HiDeoo)
        // { name: 'SocialIcons', selector: 'div.header' },
        { name: 'ThemeSelect', selector: 'starlight-theme-select label' },
        { name: 'LanguageSelect', selector: 'starlight-lang-select label' },
      ]
      #tooltip: HTMLDivElement | undefined

      constructor() {
        super()

        if (!StarlightOverrideMap.#didRegisterListeners) {
          this.#registerListeners()
          this.#createTooltip()
        }
      }

      #registerListeners() {
        StarlightOverrideMap.#didRegisterListeners = true

        const overlays = new Map()

        for (const override of StarlightOverrideMap.#overrides) {
          const elements = document.querySelectorAll(override.selector)
          // TODO(HiDeoo) validate only 1 element (not always the case)
          // TODO(HiDeoo) loop over multiple elements

          // TODO(HiDeoo) focus event too
          elements[0]?.addEventListener(
            'mouseover',
            () => {
              // TODO(HiDeoo) use this for opacity and z-index
              const depth = overlays.size
              console.error('ðŸš¨ [SocialIcons.astro:54] depth:', depth)

              const overlay = document.createElement('div')
              overlay.style.backgroundColor = 'rgba(255, 0, 0, 0.1)'
              overlay.style.border = '2px dashed red'
              overlay.style.pointerEvents = 'none'
              overlay.style.position = 'absolute'
              overlay.style.zIndex = '100'

              // TODO(HiDeoo) padding/margin?
              const rect = elements[0].getBoundingClientRect()
              overlay.style.top = `${rect.top}px`
              overlay.style.left = `${rect.left}px`
              overlay.style.width = `${rect.width}px`
              overlay.style.height = `${rect.height}px`

              this.#showTooltip(override)
              // TODO(HiDeoo) move to showTooltip
              // TODO(HiDeoo) position to handle viewport/current position
              this.#tooltip.style.top = `${rect.top + rect.height}px`
              this.#tooltip.style.left = `${rect.left}px`

              document.body.append(overlay)

              overlays.set(elements[0], overlay)
            },
            { capture: true },
          )

          // TODO(HiDeoo) blur
          elements[0]?.addEventListener('mouseout', () => {
            overlays.get(elements[0])?.remove()

            this.#hideTooltip()
          })
        }
      }

      #createTooltip() {
        this.#tooltip = document.createElement('div')
        this.#tooltip.style.backgroundColor = 'rgba(0, 0, 0, 0.5)'
        this.#tooltip.style.borderRadius = '0.5rem'
        this.#tooltip.style.color = 'white'
        this.#tooltip.style.padding = '0.5rem'
        this.#tooltip.style.position = 'absolute'
        this.#tooltip.style.zIndex = '101'
        this.#tooltip.style.top = '0'
        this.#tooltip.style.left = '0'
        this.#tooltip.textContent = 'Starlight Override'
        this.#tooltip.style.display = 'none'

        document.body.append(this.#tooltip)
      }

      #showTooltip(override: Override) {
        if (!this.#tooltip) return

        this.#tooltip.style.display = 'block'
        this.#tooltip.textContent = override.name
      }

      #hideTooltip() {
        if (!this.#tooltip) return

        this.#tooltip.style.display = 'none'
      }
    },
  )

  interface Override {
    name: string
    selector: string
  }
</script>
